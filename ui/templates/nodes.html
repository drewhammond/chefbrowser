{{ define "content"}}
  {{ if eq .total 0 }}
  <div class="text-center py-5">
    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="text-muted mb-3" viewBox="0 0 16 16">
      <path d="M4 2v2H2V2zm1 12v-2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1m0-5V7a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1m0-5V2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1m5 10v-2a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1m0-5V7a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1m0-5V2a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1M9 2v2H7V2zm5 0v2h-2V2zM4 7v2H2V7zm5 0v2H7V7zm5 0h-2v2h2zM4 12v2H2v-2zm5 0v2H7v-2zm5 0v2h-2v-2zM15 1a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zm0 5a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1zm0 5a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"/>
    </svg>
    <h4 class="text-muted">No nodes found</h4>
    {{ if .query }}
    <p class="text-muted">No results for "{{ .query }}"</p>
    <a href="{{ base_path }}/ui/nodes" class="btn btn-outline-secondary btn-sm">Clear search</a>
    {{ else }}
    <p class="text-muted">There are no nodes registered on this Chef server.</p>
    {{ end }}
  </div>
  {{ else }}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Nodes <small class="text-muted">({{ .total }})</small></h2>
    <div class="d-flex gap-2 align-items-center">
      <input type="text" id="table-filter" class="form-control form-control-sm" placeholder="Filter this page..." style="width: 200px;">
      <div class="dropdown">
        <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false" style="border: 1px solid var(--bs-border-color); background-color: var(--bs-body-bg);">
          Columns
        </button>
        <ul class="dropdown-menu dropdown-menu-end" id="column-toggles">
          <li><label class="dropdown-item"><input type="checkbox" class="form-check-input me-2" data-col="name" checked disabled> Name</label></li>
          <li><label class="dropdown-item"><input type="checkbox" class="form-check-input me-2" data-col="ip" checked> IP Address</label></li>
          <li><label class="dropdown-item"><input type="checkbox" class="form-check-input me-2" data-col="lastrun" checked> Last Run</label></li>
          <li><label class="dropdown-item"><input type="checkbox" class="form-check-input me-2" data-col="environment" checked> Environment</label></li>
        </ul>
      </div>
      <select id="per-page-select" class="form-select form-select-sm" style="width: auto;">
        <option value="0"{{ if eq .per_page 0 }} selected{{ end }}>All</option>
        <option value="50"{{ if eq .per_page 50 }} selected{{ end }}>50</option>
        <option value="100"{{ if eq .per_page 100 }} selected{{ end }}>100</option>
        <option value="500"{{ if eq .per_page 500 }} selected{{ end }}>500</option>
        <option value="1000"{{ if eq .per_page 1000 }} selected{{ end }}>1000</option>
      </select>
    </div>
  </div>

  {{ if gt .total_pages 1 }}
  <nav aria-label="Node pagination" class="mb-3">
    <ul class="pagination pagination-sm mb-0">
      {{ if gt .page 1 }}
      <li class="page-item">
        <a class="page-link" href="{{ base_path }}/ui/nodes?page={{ sub .page 1 }}{{ if .query }}&q={{ .query }}{{ end }}&per_page={{ .per_page }}">Previous</a>
      </li>
      {{ else }}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {{ end }}

      <li class="page-item disabled"><span class="page-link">Page {{ .page }} of {{ .total_pages }}</span></li>

      {{ if lt .page .total_pages }}
      <li class="page-item">
        <a class="page-link" href="{{ base_path }}/ui/nodes?page={{ add .page 1 }}{{ if .query }}&q={{ .query }}{{ end }}&per_page={{ .per_page }}">Next</a>
      </li>
      {{ else }}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
      {{ end }}
    </ul>
  </nav>
  {{ end }}

  <div class="table-responsive">
    <table class="table table-hover table-sm nodes-table" id="nodes-table">
      <thead>
        <tr>
          <th class="sortable resizable" data-col="name" data-sort="asc">Name <span class="sort-icon">▲</span></th>
          <th class="sortable resizable" data-col="ip">IP Address <span class="sort-icon"></span></th>
          <th class="sortable resizable" data-col="lastrun">Last Run <span class="sort-icon"></span></th>
          <th class="sortable resizable" data-col="environment">Environment <span class="sort-icon"></span></th>
        </tr>
      </thead>
      <tbody>
        {{ range .nodes }}
        <tr>
          <td data-col="name"><a href="{{ base_path }}/ui/nodes/{{ .Name }}">{{ .Name }}</a></td>
          <td data-col="ip">{{ if .IPAddress }}{{ .IPAddress }}{{ else }}<span class="text-muted">-</span>{{ end }}</td>
          <td data-col="lastrun" class="last-run-cell" data-ohai-time="{{ .OhaiTime }}">{{ if .OhaiTime }}<span class="text-muted">-</span>{{ else }}<span class="text-muted">-</span>{{ end }}</td>
          <td data-col="environment">{{ if .Environment }}<a href="{{ base_path }}/ui/environments/{{ .Environment }}">{{ .Environment }}</a>{{ else }}<span class="text-muted">-</span>{{ end }}</td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>

  {{ if gt .total_pages 1 }}
  <nav aria-label="Node pagination">
    <ul class="pagination pagination-sm">
      {{ if gt .page 1 }}
      <li class="page-item">
        <a class="page-link" href="{{ base_path }}/ui/nodes?page={{ sub .page 1 }}{{ if .query }}&q={{ .query }}{{ end }}&per_page={{ .per_page }}">Previous</a>
      </li>
      {{ else }}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {{ end }}

      <li class="page-item disabled"><span class="page-link">Page {{ .page }} of {{ .total_pages }}</span></li>

      {{ if lt .page .total_pages }}
      <li class="page-item">
        <a class="page-link" href="{{ base_path }}/ui/nodes?page={{ add .page 1 }}{{ if .query }}&q={{ .query }}{{ end }}&per_page={{ .per_page }}">Next</a>
      </li>
      {{ else }}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
      {{ end }}
    </ul>
  </nav>
  {{ end }}
  {{ end }}

  <script type="module">
    const table = document.getElementById('nodes-table');
    const tableBody = table.querySelector('tbody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));

    // Format last run times and store numeric value for sorting
    document.querySelectorAll('.last-run-cell').forEach(cell => {
      const ohaiTime = parseFloat(cell.dataset.ohaiTime);
      if (ohaiTime && ohaiTime > 0) {
        const lastRun = dayjs.unix(ohaiTime);
        cell.textContent = dayjs().to(lastRun);
        cell.title = lastRun.format('YYYY-MM-DD HH:mm:ss');
      }
    });

    // Column visibility
    const STORAGE_KEY = 'chefbrowser_nodes_columns';
    const savedCols = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

    function applyColumnVisibility() {
      document.querySelectorAll('#column-toggles input[data-col]').forEach(checkbox => {
        const col = checkbox.dataset.col;
        if (col === 'name') return;
        const visible = savedCols[col] !== false;
        checkbox.checked = visible;
        table.querySelectorAll(`[data-col="${col}"]`).forEach(el => {
          el.style.display = visible ? '' : 'none';
        });
      });
    }
    applyColumnVisibility();

    document.querySelectorAll('#column-toggles input[data-col]').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const col = e.target.dataset.col;
        savedCols[col] = e.target.checked;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedCols));
        table.querySelectorAll(`[data-col="${col}"]`).forEach(el => {
          el.style.display = e.target.checked ? '' : 'none';
        });
      });
    });

    // Client-side sorting
    const headers = table.querySelectorAll('th.sortable');
    headers.forEach(header => {
      header.style.cursor = 'pointer';
      header.addEventListener('click', () => {
        const col = header.dataset.col;
        const currentSort = header.dataset.sort;
        const newSort = currentSort === 'asc' ? 'desc' : 'asc';

        headers.forEach(h => {
          h.dataset.sort = '';
          h.querySelector('.sort-icon').textContent = '';
        });
        header.dataset.sort = newSort;
        header.querySelector('.sort-icon').textContent = newSort === 'asc' ? '▲' : '▼';

        rows.sort((a, b) => {
          let aVal = a.querySelector(`[data-col="${col}"]`).textContent.trim();
          let bVal = b.querySelector(`[data-col="${col}"]`).textContent.trim();

          if (col === 'lastrun') {
            const aTime = parseFloat(a.querySelector(`[data-col="${col}"]`).dataset.ohaiTime) || 0;
            const bTime = parseFloat(b.querySelector(`[data-col="${col}"]`).dataset.ohaiTime) || 0;
            return newSort === 'asc' ? aTime - bTime : bTime - aTime;
          }

          const cmp = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: 'base' });
          return newSort === 'asc' ? cmp : -cmp;
        });

        rows.forEach(row => tableBody.appendChild(row));
      });
    });

    // Client-side table filtering
    const filterInput = document.getElementById('table-filter');
    filterInput.addEventListener('input', (e) => {
      const filter = e.target.value.toLowerCase();
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
      });
    });

    // Per-page selector
    const perPageSelect = document.getElementById('per-page-select');
    perPageSelect.addEventListener('change', (e) => {
      const url = new URL(window.location.href);
      url.searchParams.set('per_page', e.target.value);
      url.searchParams.set('page', '1');
      window.location.href = url.toString();
    });

    // Column resizing
    const WIDTHS_KEY = 'chefbrowser_nodes_widths';
    const savedWidths = JSON.parse(localStorage.getItem(WIDTHS_KEY) || '{}');

    headers.forEach(header => {
      const col = header.dataset.col;
      if (savedWidths[col]) {
        header.style.width = savedWidths[col];
      }

      const resizer = document.createElement('div');
      resizer.className = 'col-resizer';
      header.appendChild(resizer);

      let startX, startWidth;
      resizer.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        startX = e.pageX;
        startWidth = header.offsetWidth;
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });

      function onMouseMove(e) {
        const width = startWidth + (e.pageX - startX);
        header.style.width = width + 'px';
      }

      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        savedWidths[col] = header.style.width;
        localStorage.setItem(WIDTHS_KEY, JSON.stringify(savedWidths));
      }
    });
  </script>
{{ end }}
